<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kafle z Arkusza Google</title>
  <style>
    /* Dodaj stylizację kafli */
    .tile {
      border: 1px solid #ddd;
      padding: 10px;
      margin: 10px;
      width: 300px;
      float: left; /* Kaflowy układ - jeden obok drugiego */
    }

    .tile img {
      max-width: 100%;
      height: auto;
    }
  </style>
</head>
<body>

<div id="tiles-container"></div>

<script>
// Adres URL publicznego arkusza
const sheetUrl = 'https://docs.google.com/spreadsheets/d/1hTaNoVxeK5HBXI7FHMMPKznvILbudUpxgRslYouw34Q/pubhtml';

// Funkcja do pobierania danych z arkusza
async function fetchData() {
  try {
    const response = await fetch('https://docs.google.com/spreadsheets/d/1hTaNoVxeK5HBXI7FHMMPKznvILbudUpxgRslYouw34Q/pubhtml');
    const data = await response.text();

    // Parsuj dane HTML do struktury DOM
    const parser = new DOMParser();
    const doc = parser.parseFromString(data, 'text/html');

    // Znajdź tabelę danych w arkuszu
    const table = doc.querySelector('table');

    // Pobierz wszystkie wiersze z tabeli, zaczynając od drugiego wiersza (indeks 1)
    const rows = Array.from(table.querySelectorAll('tbody tr')).slice(1);

    // Tworzenie kafli dla każdego wiersza, spełniającego warunki
    const tilesContainer = document.getElementById('tiles-container');

    // Mapowanie obietnic do stworzenia kafli
    const tilePromises = rows.map(async (row, index) => {
      const columns = row.querySelectorAll('td');
      const nr = columns[2].textContent.trim();

      // Pomijaj wiersze, w których kolumna NR jest pusta
      if (!nr) {
        return null;
      }

      const tile = await createTile(columns, index + 2); // Zaczynamy od drugiego wiersza, indeks 2
      return tile;
    });

    // Oczekiwanie na zakończenie wszystkich obietnic i dodanie kafli do kontenera
    const tiles = (await Promise.all(tilePromises)).filter(tile => tile !== null);
    tiles.forEach(tile => {
      tilesContainer.appendChild(tile);
    });

  } catch (error) {
    console.error('Błąd pobierania danych:', error);
  }
}

// Funkcja do tworzenia kafli na podstawie danych z wiersza
async function createTile(columns, row) {
  const wytwornia = columns[0].textContent.trim();
  const nr = columns[2].textContent.trim();
  const artystaZespol = columns[3].textContent.trim() + ' - ' + columns[4].textContent.trim();
  const discogsLink = columns[5].textContent.trim();
  const ilosc = parseInt(columns[6].textContent.trim());
  const uwagi = columns[7].textContent.trim();
  const dataNabycia = columns[8].textContent.trim();
  const kolor = columns[9].textContent.trim();

  // Pomijaj wiersze, w których brak linku do Discogs
  if (!discogsLink) {
    return null;
  }

  // Pobierz wartość koloru bezpośrednio z arkusza Google Sheets (kolumna 10)
  const kafelColor = kolor ? kolor : 'black'; // Domyślnie czarny, jeśli kolor nie jest określony

  // Utwórz element kafla
  const tile = document.createElement('div');
  tile.classList.add('tile');
  tile.style.backgroundColor = kafelColor;

  // Ustaw kolor tekstu
  tile.style.color = kafelColor === 'black' ? 'gold' : 'white';

  // Zaktualizowane proporcje dla kafli
  tile.style.width = '300px'; // Dostosuj szerokość według potrzeb
  tile.style.height = '400px'; // Dostosuj wysokość według potrzeb

  // Zaktualizuj czcionkę
  tile.style.fontFamily = 'sans-serif';

  // Dodaj pole dla miniatury albumu z Discogs
  const thumbnailContainer = document.createElement('div');
  thumbnailContainer.classList.add('thumbnail-container');
  const thumbnailUrl = await fetchDiscogsThumbnail(discogsLink);
  if (thumbnailUrl) {
    thumbnailContainer.style.backgroundImage = `url(${thumbnailUrl})`;
  }
  tile.appendChild(thumbnailContainer);

  // Dodaj zawartość do kafla
  tile.innerHTML += `
    <h3>${wytwornia}</h3>
    <p><strong>${artystaZespol}</strong></p>
    <p>Nr: ${nr}</p>
    <p>Ilość: <strong>${ilosc}</strong></p>
    <p>${uwagi}</p>
    <p>Data nabycia: ${ilosc !== 0 ? dataNabycia : 'Brak'}</p>
  `;

  return tile;
}

// Funkcja do pobierania miniatury albumu z Discogs
async function fetchDiscogsThumbnail(discogsLink) {
  try {
    const response = await fetch(`https://api.discogs.com/database/search?q=${encodeURIComponent(discogsLink)}`);
    const data = await response.json();
    const firstResult = data.results[0];

    if (firstResult && firstResult.thumb) {
      return firstResult.thumb;
    }

    return null;
  } catch (error) {
    console.error('Błąd pobierania miniatury z Discogs:', error);
    return null;
  }
}

// Pobierz dane po załadowaniu strony
window.onload = function () {
  // Zmiana tytułu strony
  document.title = "Moja kolekcja kaset ECHO/JAM";
  fetchData();
};
</script>

</body>
</html>
